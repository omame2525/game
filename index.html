<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport"
content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ãƒãƒ ã¡ã‚ƒã‚“ãƒ€ãƒƒã‚·ãƒ¥32</title>
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<style>
body{margin:0;background:#ffd6e7;text-align:center;font-family:sans-serif;overflow:hidden;}
.track{position:relative;width:95vw;height:160px;background:white;margin:10px auto;border-radius:15px;}
canvas{position:absolute;top:30px;image-rendering:pixelated;}
button,input{font-size:16px;padding:6px;margin:4px;border-radius:8px;border:none;}
button{background:#ff9ecf;color:white;}
#status{font-weight:bold;margin:5px;}
#result{font-size:20px;font-weight:bold;margin-top:10px;}
</style>
</head>
<body>
<h2>ğŸ¹ ãƒãƒ ã¡ã‚ƒã‚“ãƒ€ãƒƒã‚·ãƒ¥32</h2>
<div id="status"></div>
<input id="playerName" placeholder="è‡ªåˆ†ã®ãƒãƒ ã‚¹ã‚¿ãƒ¼å">
<button onclick="startRace()">ãƒ¬ãƒ¼ã‚¹é–‹å§‹</button>
<button onclick="boost()">ğŸ’¨ ãƒ–ãƒ¼ã‚¹ãƒˆï¼</button>
<div id="tracks"></div>
<div id="result"></div>

<script>
// ===== åŠ¹æœéŸ³ =====
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playBeep(freq,duration){
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.connect(gain); gain.connect(audioCtx.destination);
  osc.frequency.value = freq; osc.type = "square";
  osc.start();
  gain.gain.setValueAtTime(0.1,audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime + duration);
  osc.stop(audioCtx.currentTime+duration);
}

// ===== è‚²æˆãƒ‡ãƒ¼ã‚¿ =====
let playerData={level:1,exp:0};
function loadData(){const saved=localStorage.getItem("hamsterSave");if(saved)playerData=JSON.parse(saved);}
function saveData(){localStorage.setItem("hamsterSave",JSON.stringify(playerData));}
function updateStatus(){document.getElementById("status").innerText="Lv."+playerData.level+" EXP:"+playerData.exp+"/100";}
loadData(); updateStatus();

// ===== 32Ã—32ãƒ‰ãƒƒãƒˆãƒãƒ ã‚¹ã‚¿ãƒ¼ =====
const SIZE = 32;
const SCALE = 4;

// frameA è¶³é–‹ãï¼ˆç°¡æ˜“32Ã—32ï¼‰
const frameA = Array(SIZE).fill(0).map(()=>Array(SIZE).fill(0));
for(let y=8;y<16;y++){for(let x=12;x<20;x++){frameA[y][x]=1;}} // ä½“
frameA[6][14]=3; frameA[6][17]=3; // ç›®
frameA[5][13]=2; frameA[5][18]=2; // ã»ã£ãº
frameA[4][12]=4; frameA[4][19]=4; // è€³
frameA[16][14]=1; frameA[16][17]=1; // è¶³

// frameB è¶³é–‰ã˜
const frameB = JSON.parse(JSON.stringify(frameA));
frameB[16][14]=0; frameB[16][17]=0;

// CPUåå‰ã¨æ€§æ ¼
const cpuNames=["ã‚‚ãµã‚Šã‚“","ãã‚‹ã¿","ã½ã¦ã¡","ã—ã‚‰ãŸã¾"];
const personalities=[
  {name:"ã‚¹ãƒ”ãƒ¼ãƒ‰å‹",speed:2.8,stumble:0.04},
  {name:"å®‰å®šå‹",speed:2.2,stumble:0.01},
  {name:"ãŠã£ã¡ã‚‡ã“ã¡ã‚‡ã„",speed:3.2,stumble:0.07},
  {name:"ã®ã‚“ã³ã‚Š",speed:1.8,stumble:0.005}
];

function random(a){return a[Math.floor(Math.random()*a.length)];}
function createCanvas(){const c=document.createElement("canvas");c.width=SIZE;c.height=SIZE;c.style.width=(SIZE*SCALE)+"px";c.style.height=(SIZE*SCALE)+"px";return c;}
function draw(ctx,data,color,stumble){
  ctx.clearRect(0,0,SIZE,SIZE);
  if(stumble){ctx.save();ctx.translate(SIZE/2,SIZE/2);ctx.rotate(Math.PI/6);ctx.translate(-SIZE/2,-SIZE/2);}
  for(let y=0;y<SIZE;y++){
    for(let x=0;x<SIZE;x++){
      if(data[y][x]===0) continue;
      ctx.fillStyle=data[y][x]===1?color:data[y][x]===2?"#ffb6b6":data[y][x]===3?"#000":"#ffc107";
      ctx.fillRect(x,y,1,1);
    }
  }
  if(stumble) ctx.restore();
}

let racers=[],raceInterval,animInterval,boostPower=0;

function startRace(){
  clearInterval(raceInterval); clearInterval(animInterval);
  document.getElementById("tracks").innerHTML=""; document.getElementById("result").innerText="";
  racers=[]; boostPower=0;
  const playerName=document.getElementById("playerName").value || "ã‚ãªãŸã®ãƒãƒ ";
  for(let i=0;i<4;i++){
    const track=document.createElement("div"); track.className="track";
    const canvas=createCanvas(); const ctx=canvas.getContext("2d");
    const personality=random(personalities); const name=i===0?playerName:random(cpuNames);
    track.innerHTML="<div>"+name+" ("+personality.name+")</div>"; track.appendChild(canvas);
    document.getElementById("tracks").appendChild(track);
    racers.push({name,personality,canvas,ctx,pos:0,frame:0,stumble:false,stumbleTimer:0,finished:false,isPlayer:i===0,color:"#d8a45c"});
  }
  raceInterval=setInterval(updateRace,80);
  animInterval=setInterval(updateAnim,150);
}

function updateRace(){
  racers.forEach(r=>{
    if(r.finished) return;
    if(Math.random()<r.personality.stumble){r.stumble=true;r.stumbleTimer=8;playBeep(200,0.1);}
    if(r.stumble){r.stumbleTimer--; if(r.stumbleTimer<=0) r.stumble=false; return;}
    let base=r.personality.speed; if(r.isPlayer){base+=playerData.level*0.2; base+=boostPower;}
    r.pos+=base; r.canvas.style.left=r.pos+"px";
    if(r.pos>window.innerWidth*0.75){
      r.finished=true; playBeep(800,0.2);
      if(r.isPlayer){playerData.exp+=10; if(playerData.exp>=100){playerData.exp=0;playerData.level++; playBeep(1200,0.3);}
        saveData(); updateStatus();}
      document.getElementById("result").innerText="ğŸ† å„ªå‹ã¯ "+r.name+"ï¼";
    }
  });
  boostPower*=0.9;
}

function updateAnim(){
  racers.forEach(r=>{if(r.finished) return; r.frame=r.frame===0?1:0; draw(r.ctx,r.frame===0?frameA:frameB,r.color,r.stumble);});
}

function boost(){boostPower+=2; playBeep(600,0.1);}
</script>
</body>
</html>